<h1>ターン順</h1>
<ul id="turnOrderList"></ul>

<div id="fadeOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background-color: black;
  opacity: 1;
  transition: opacity 1.5s;
  z-index: 9999;
  pointer-events: none;
"></div>

<script type="module">
  import {
    initializeApp, getApps, getApp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, get
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1hyrktLnx7lzW2jf4ZeIzTrBEY-IEgPo",
    authDomain: "horror-game-9b2d2.firebaseapp.com",
    databaseURL: "https://horror-game-9b2d2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "horror-game-9b2d2",
    storageBucket: "horror-game-9b2d2.appspot.com",
    messagingSenderId: "534762448588",
    appId: "1:534762448588:web:e0a6a01cd14c7f1dce4469"
  };

  const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
  const db = getDatabase(app);

  function getRoomCodeFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("roomCode");
  }

  const roomCode = getRoomCodeFromURL();
  if (!roomCode) {
    alert("ルーム情報が見つかりませんでした");
    window.location.href = "index.html";
  }

  const fadeOverlay = document.getElementById("fadeOverlay");
  const list = document.getElementById("turnOrderList");

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  async function loadAndShowPlayers() {
    const playersSnap = await get(ref(db, `rooms/${roomCode}/players`));
    const players = playersSnap.val() || {};
    const playerNames = Object.values(players).map(p => p.name || "名無し");
    const shuffled = shuffleArray(playerNames);

    shuffled.forEach((name, index) => {
      const li = document.createElement("li");
      li.textContent = `${index + 1}. ${name}`;
      list.appendChild(li);
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
      fadeOverlay.style.opacity = "0";
    }, 100);

    fadeOverlay.addEventListener("transitionend", () => {
      fadeOverlay.style.display = "none";
      loadAndShowPlayers();
    });
  });
</script>
