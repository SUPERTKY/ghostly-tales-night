// ğŸ” ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šWebRTCæ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã‚³ãƒ¼ãƒ‰
// ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„

function debugWebRTCStatus() {
  console.log("=== WebRTC ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===");
  
  // 1. åŸºæœ¬çŠ¶æ…‹ã®ç¢ºèª
  console.log("ğŸ” åŸºæœ¬çŠ¶æ…‹:");
  console.log("- currentUserId:", currentUserId);
  console.log("- roomCode:", roomCode);
  console.log("- cameraStarted:", cameraStarted);
  console.log("- localStream:", localStream);
  
  // 2. PeerConnectionçŠ¶æ…‹
  console.log("\nğŸ”— PeerConnectionçŠ¶æ…‹:");
  console.log("- peerConnections:", Object.keys(peerConnections));
  
  Object.entries(peerConnections).forEach(([uid, pc]) => {
    console.log(`  ${uid}:`);
    console.log(`    - connectionState: ${pc.connectionState}`);
    console.log(`    - iceConnectionState: ${pc.iceConnectionState}`);
    console.log(`    - signalingState: ${pc.signalingState}`);
    console.log(`    - localDescription: ${pc.localDescription ? 'ã‚ã‚Š' : 'ãªã—'}`);
    console.log(`    - remoteDescription: ${pc.remoteDescription ? 'ã‚ã‚Š' : 'ãªã—'}`);
  });
  
  // 3. ãƒ“ãƒ‡ã‚ªè¦ç´ ã®ç¢ºèª
  console.log("\nğŸ“º ãƒ“ãƒ‡ã‚ªè¦ç´ :");
  const videos = document.querySelectorAll('video');
  console.log(`- ç·ãƒ“ãƒ‡ã‚ªè¦ç´ æ•°: ${videos.length}`);
  
  videos.forEach((video, index) => {
    const userId = video.getAttribute('data-user-id');
    console.log(`  ãƒ“ãƒ‡ã‚ª${index + 1}:`);
    console.log(`    - data-user-id: ${userId || 'æœªè¨­å®š(ãƒ­ãƒ¼ã‚«ãƒ«)'}`);
    console.log(`    - srcObject: ${video.srcObject ? 'ã‚ã‚Š' : 'ãªã—'}`);
    console.log(`    - videoWidth: ${video.videoWidth}`);
    console.log(`    - videoHeight: ${video.videoHeight}`);
    console.log(`    - readyState: ${video.readyState}`);
    console.log(`    - paused: ${video.paused}`);
    
    if (video.srcObject) {
      const tracks = video.srcObject.getTracks();
      console.log(`    - ãƒˆãƒ©ãƒƒã‚¯æ•°: ${tracks.length}`);
      tracks.forEach((track, i) => {
        console.log(`      ãƒˆãƒ©ãƒƒã‚¯${i + 1}: ${track.kind} - enabled: ${track.enabled} - state: ${track.readyState}`);
      });
    }
  });
  
  // 4. Firebaseä¸Šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ç¢ºèªï¼ˆéåŒæœŸï¼‰
  console.log("\nğŸ”¥ Firebase ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ç¢ºèªä¸­...");
  get(ref(db, `rooms/${roomCode}/players`)).then(snapshot => {
    if (snapshot.exists()) {
      const players = snapshot.val();
      console.log("Firebase ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹:");
      Object.entries(players).forEach(([uid, data]) => {
        console.log(`  ${uid}:`);
        console.log(`    - name: ${data.name}`);
        console.log(`    - cameraReady: ${data.cameraReady}`);
        console.log(`    - ready: ${data.ready}`);
        console.log(`    - lastSeen: ${data.lastSeen ? new Date(data.lastSeen).toLocaleTimeString() : 'æœªè¨­å®š'}`);
      });
    }
  });
  
  // 5. ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
  console.log("\nğŸ“¡ ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...");
  get(ref(db, `rooms/${roomCode}/signals`)).then(snapshot => {
    if (snapshot.exists()) {
      const signals = snapshot.val();
      console.log("ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿:");
      Object.entries(signals).forEach(([fromUID, toMap]) => {
        Object.entries(toMap).forEach(([toUID, data]) => {
          console.log(`  ${fromUID} â†’ ${toUID}:`);
          console.log(`    - offer: ${data.offer ? 'ã‚ã‚Š' : 'ãªã—'}`);
          console.log(`    - answer: ${data.answer ? 'ã‚ã‚Š' : 'ãªã—'}`);
          console.log(`    - candidates: ${data.candidates ? Object.keys(data.candidates).length + 'å€‹' : 'ãªã—'}`);
        });
      });
    } else {
      console.log("ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãªã—");
    }
  });
}

// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
debugWebRTCStatus();
