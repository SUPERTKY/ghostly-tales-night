// ğŸ”§ ä¿®æ­£ç‰ˆï¼šontrack ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆline 585ä»˜è¿‘ã‚’ç½®ãæ›ãˆï¼‰
pc.ontrack = (event) => {
  const stream = event.streams[0];
  if (!stream) return;

  const track = stream?.getVideoTracks?.()[0];
  console.log("ğŸ¥ æ˜ åƒã‚’å—ä¿¡ from", fromUID);
  console.log("ğŸ“º stream:", stream);
  console.log("ğŸ“º videoTrack state:", track?.readyState);
  console.log("ğŸ“º videoTrack enabled:", track?.enabled);
  console.log("ğŸ“º videoTrack label:", track?.label);
  console.log("ğŸ“º stream track count:", stream.getTracks().length);

  const videoGrid = document.getElementById("videoGrid");
  videoGrid.style.display = "flex";

  // ğŸ”§ ä¿®æ­£ï¼šæ—¢å­˜ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ç¢ºå®Ÿã«å‰Šé™¤
  const existingVideo = document.querySelector(`video[data-user-id="${fromUID}"]`);
  if (existingVideo) {
    console.log(`ğŸ—‘ï¸ ${fromUID}ã®æ—¢å­˜ãƒ“ãƒ‡ã‚ªã‚’å‰Šé™¤`);
    existingVideo.remove();
  }

  // ğŸ”§ ä¿®æ­£ï¼šæ–°ã—ã„ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆï¼ˆremoteStreamã‚’çµŒç”±ã—ãªã„ï¼‰
  const remoteVideo = document.createElement("video");
  remoteVideo.setAttribute("data-user-id", fromUID);
  remoteVideo.autoplay = true;
  remoteVideo.playsInline = true;
  remoteVideo.muted = true;
  remoteVideo.style.width = "200px";
  remoteVideo.style.height = "150px";
  remoteVideo.style.margin = "10px";
  remoteVideo.style.border = "3px solid #00ff00"; // ç·‘æ ã§ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªã‚’è­˜åˆ¥
  remoteVideo.style.borderRadius = "8px";

  // ğŸ”§ é‡è¦ï¼šã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç›´æ¥è¨­å®š
  remoteVideo.srcObject = stream;
  
  // ğŸ”§ ä¿®æ­£ï¼šDOMã«è¿½åŠ ã—ã¦ã‹ã‚‰å†ç”Ÿ
  videoGrid.appendChild(remoteVideo);
  console.log(`ğŸ“º ${fromUID}ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’DOMã«è¿½åŠ `);

  // ğŸ”§ ä¿®æ­£ï¼šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å†ç”Ÿ
  remoteVideo.onloadedmetadata = () => {
    console.log(`ğŸ“º ${fromUID}ã®ãƒ“ãƒ‡ã‚ªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†`);
    console.log(`ğŸ“º ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º: ${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`);
  };

  remoteVideo.oncanplay = () => {
    console.log(`ğŸ“º ${fromUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿæº–å‚™å®Œäº†`);
  };

  remoteVideo.onplay = () => {
    console.log(`â–¶ï¸ ${fromUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹`);
  };

  remoteVideo.onerror = (error) => {
    console.error(`âŒ ${fromUID}ã®ãƒ“ãƒ‡ã‚ªã‚¨ãƒ©ãƒ¼:`, error);
  };

  // ğŸ”§ ä¿®æ­£ï¼šå°‘ã—é…å»¶ã—ã¦ã‹ã‚‰å†ç”Ÿã‚’è©¦è¡Œ
  setTimeout(() => {
    remoteVideo.play()
      .then(() => {
        console.log(`âœ… ${fromUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”ŸæˆåŠŸ`);
      })
      .catch(err => {
        console.warn(`âš ï¸ ${fromUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿå¤±æ•—:`, err);
        // ğŸ”§ ä¿®æ­£ï¼šå†ç”Ÿå¤±æ•—æ™‚ã¯æ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        addPlayButton(remoteVideo, fromUID);
      });
  }, 100);
};

// ğŸ”§ æ–°è¦è¿½åŠ ï¼šæ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³é–¢æ•°
function addPlayButton(videoElement, userId) {
  // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
  const existingButton = document.querySelector(`button[data-video-id="${userId}"]`);
  if (existingButton) {
    existingButton.remove();
  }

  const playButton = document.createElement("button");
  playButton.textContent = `${userId}ã®æ˜ åƒã‚’å†ç”Ÿ`;
  playButton.setAttribute("data-video-id", userId);
  playButton.style.position = "absolute";
  playButton.style.zIndex = "1000";
  playButton.style.backgroundColor = "#00ff00";
  playButton.style.color = "black";
  playButton.style.padding = "5px 10px";
  playButton.style.border = "none";
  playButton.style.borderRadius = "5px";
  playButton.style.cursor = "pointer";
  
  playButton.onclick = () => {
    videoElement.play()
      .then(() => {
        playButton.remove();
        console.log(`âœ… ${userId}ã®æ‰‹å‹•å†ç”ŸæˆåŠŸ`);
      })
      .catch(err => {
        console.error(`âŒ ${userId}ã®æ‰‹å‹•å†ç”Ÿå¤±æ•—:`, err);
        alert(`${userId}ã®æ˜ åƒå†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
      });
  };
  
  // ãƒ“ãƒ‡ã‚ªè¦ç´ ã®å¾Œã«æŒ¿å…¥
  videoElement.parentNode.insertBefore(playButton, videoElement.nextSibling);
}
