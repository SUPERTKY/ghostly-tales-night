// ğŸ”§ ä¿®æ­£ç‰ˆï¼šãƒ“ãƒ‡ã‚ªå†ç”Ÿã®å®‰å®šåŒ–ï¼ˆ834è¡Œç›®ä»˜è¿‘ã‚’ç½®ãæ›ãˆï¼‰

// æ—¢å­˜ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªã‚’å®‰å…¨ã«å‰Šé™¤
const existingRemoteVideo = document.querySelector(`video[data-user-id="${remoteUID}"]`);
if (existingRemoteVideo) {
  console.log(`ğŸ—‘ï¸ ${remoteUID}ã®æ—¢å­˜ãƒ“ãƒ‡ã‚ªã‚’å‰Šé™¤`);
  // å†ç”Ÿä¸­ã®å ´åˆã¯åœæ­¢ã—ã¦ã‹ã‚‰å‰Šé™¤
  if (!existingRemoteVideo.paused) {
    existingRemoteVideo.pause();
  }
  existingRemoteVideo.srcObject = null;
  existingRemoteVideo.remove();
}

// å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ–°ã—ã„ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆ
setTimeout(() => {
  const remoteVideo = document.createElement("video");
  remoteVideo.setAttribute("data-user-id", remoteUID);
  remoteVideo.autoplay = false; // ğŸ”§ é‡è¦ï¼šautoplayã‚’ç„¡åŠ¹ã«ã—ã¦æ‰‹å‹•åˆ¶å¾¡
  remoteVideo.playsInline = true;
  remoteVideo.muted = true;
  remoteVideo.style.width = "200px";
  remoteVideo.style.height = "150px";
  remoteVideo.style.margin = "10px";
  remoteVideo.style.border = "3px solid #00ff00";
  remoteVideo.style.borderRadius = "8px";

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å…ˆã«è¨­å®š
  remoteVideo.onloadedmetadata = () => {
    console.log(`ğŸ“º ${remoteUID}ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†`);
    console.log(`ğŸ“º ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º: ${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`);
    
    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«å†ç”Ÿã‚’è©¦è¡Œ
    remoteVideo.play()
      .then(() => {
        console.log(`âœ… ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”ŸæˆåŠŸ`);
      })
      .catch(err => {
        console.warn(`âš ï¸ ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿå¤±æ•—:`, err);
        // æ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        showPlayButton(remoteVideo, remoteUID);
      });
  };

  remoteVideo.onplay = () => {
    console.log(`â–¶ï¸ ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹`);
  };

  remoteVideo.onerror = (error) => {
    console.error(`âŒ ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªã‚¨ãƒ©ãƒ¼:`, error);
  };

  remoteVideo.oncanplay = () => {
    console.log(`ğŸ“º ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿæº–å‚™å®Œäº†`);
  };

  // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¨­å®š
  remoteVideo.srcObject = stream;
  
  // DOMã«è¿½åŠ 
  const videoGrid = document.getElementById("videoGrid");
  videoGrid.appendChild(remoteVideo);
  console.log(`ğŸ“º ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’DOMã«è¿½åŠ `);

}, 100); // 100mså¾…æ©Ÿ

// ğŸ”§ æ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³è¡¨ç¤ºé–¢æ•°
function showPlayButton(videoElement, userId) {
  // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
  const existingButton = document.querySelector(`button[data-play-for="${userId}"]`);
  if (existingButton) {
    existingButton.remove();
  }

  const playButton = document.createElement("button");
  playButton.textContent = `â–¶ï¸ ${userId}ã®æ˜ åƒã‚’å†ç”Ÿ`;
  playButton.setAttribute("data-play-for", userId);
  playButton.style.position = "relative";
  playButton.style.display = "block";
  playButton.style.margin = "10px auto";
  playButton.style.padding = "10px 15px";
  playButton.style.backgroundColor = "#00ff00";
  playButton.style.color = "#000";
  playButton.style.border = "none";
  playButton.style.borderRadius = "5px";
  playButton.style.cursor = "pointer";
  playButton.style.fontSize = "14px";
  playButton.style.fontWeight = "bold";
  
  playButton.onclick = () => {
    videoElement.play()
      .then(() => {
        console.log(`âœ… ${userId}ã®æ‰‹å‹•å†ç”ŸæˆåŠŸ`);
        playButton.remove();
      })
      .catch(err => {
        console.error(`âŒ ${userId}ã®æ‰‹å‹•å†ç”Ÿå¤±æ•—:`, err);
        alert(`æ˜ åƒã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
      });
  };
  
  // ãƒ“ãƒ‡ã‚ªè¦ç´ ã®å¾Œã«æŒ¿å…¥
  videoElement.parentNode.insertBefore(playButton, videoElement.nextSibling);
}
