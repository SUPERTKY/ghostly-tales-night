// ğŸ”§ å®Œå…¨ãª pc.ontrack ç½®ãæ›ãˆç‰ˆ
// å…ƒã®pc.ontrack = (event) => { ã‹ã‚‰ }; ã¾ã§ã‚’ã€ä»¥ä¸‹ã§ç½®ãæ›ãˆã¦ãã ã•ã„

pc.ontrack = (event) => {
  const stream = event.streams[0];
  if (!stream) return;

  // ğŸ”§ ä¿®æ­£ï¼šremoteUIDã‚’æ­£ã—ãç‰¹å®š
  const remoteUID = Object.keys(peerConnections).find(uid => peerConnections[uid] === pc) || 'unknown';
  
  const track = stream?.getVideoTracks?.[0];
  console.log("ğŸ¥ æ˜ åƒã‚’å—ä¿¡ from", remoteUID);
  console.log("ğŸ“º stream:", stream);
  console.log("ğŸ“º videoTrack state:", track?.readyState);
  console.log("ğŸ“º videoTrack enabled:", track?.enabled);
  console.log("ğŸ“º videoTrack label:", track?.label);
  console.log("ğŸ“º stream track count:", stream.getTracks().length);

  const videoGrid = document.getElementById("videoGrid");
  videoGrid.style.display = "flex";

  // æ—¢å­˜ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªã‚’å‰Šé™¤
  const existingRemoteVideo = document.querySelector(`video[data-user-id="${remoteUID}"]`);
  if (existingRemoteVideo) {
    console.log(`ğŸ—‘ï¸ ${remoteUID}ã®æ—¢å­˜ãƒ“ãƒ‡ã‚ªã‚’å‰Šé™¤`);
    existingRemoteVideo.remove();
  }

  // æ–°ã—ã„ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆ
  const remoteVideo = document.createElement("video");
  remoteVideo.setAttribute("data-user-id", remoteUID);
  remoteVideo.autoplay = true;
  remoteVideo.playsInline = true;
  remoteVideo.muted = true;
  remoteVideo.style.width = "200px";
  remoteVideo.style.height = "150px";
  remoteVideo.style.margin = "10px";
  remoteVideo.style.border = "3px solid #00ff00"; // ç·‘æ ã§ãƒªãƒ¢ãƒ¼ãƒˆã‚’è­˜åˆ¥
  remoteVideo.style.borderRadius = "8px";

  // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç›´æ¥è¨­å®š
  remoteVideo.srcObject = stream;
  
  // DOMã«è¿½åŠ 
  videoGrid.appendChild(remoteVideo);
  console.log(`ğŸ“º ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’DOMã«è¿½åŠ `);

  // å†ç”Ÿã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  remoteVideo.onloadedmetadata = () => {
    console.log(`ğŸ“º ${remoteUID}ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†`);
  };

  remoteVideo.onplay = () => {
    console.log(`â–¶ï¸ ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹`);
  };

  remoteVideo.onerror = (error) => {
    console.error(`âŒ ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªã‚¨ãƒ©ãƒ¼:`, error);
  };

  // å†ç”Ÿã‚’è©¦è¡Œ
  remoteVideo.play()
    .then(() => {
      console.log(`âœ… ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”ŸæˆåŠŸ`);
    })
    .catch(err => {
      console.warn(`âš ï¸ ${remoteUID}ã®ãƒ“ãƒ‡ã‚ªå†ç”Ÿå¤±æ•—:`, err);
      
      // æ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      const playButton = document.createElement("button");
      playButton.textContent = `${remoteUID}ã®æ˜ åƒã‚’å†ç”Ÿ`;
      playButton.style.position = "absolute";
      playButton.style.zIndex = "1000";
      playButton.style.backgroundColor = "#00ff00";
      playButton.style.color = "black";
      playButton.style.padding = "8px 12px";
      playButton.style.border = "none";
      playButton.style.borderRadius = "5px";
      playButton.style.cursor = "pointer";
      playButton.style.margin = "10px";
      
      playButton.onclick = () => {
        remoteVideo.play()
          .then(() => {
            playButton.remove();
            console.log(`âœ… ${remoteUID}ã®æ‰‹å‹•å†ç”ŸæˆåŠŸ`);
          })
          .catch(err2 => {
            console.error(`âŒ ${remoteUID}ã®æ‰‹å‹•å†ç”Ÿã‚‚å¤±æ•—:`, err2);
          });
      };
      
      videoGrid.appendChild(playButton);
    });
};
