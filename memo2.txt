// ğŸ”§ ä¿®æ­£å‰ï¼ˆå•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ï¼‰
/*
// å…ƒã®ã‚³ãƒ¼ãƒ‰ï¼ˆlines 300-310ä»˜è¿‘ï¼‰
if (info.cameraReady && myUID < uid && !peerConnections[uid]) {
  console.log("ğŸ›°ï¸ ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†ã‚’æ¤œçŸ¥ã€æ¥ç¶šé–‹å§‹ to:", uid);
  await createConnectionWith(uid);
}
*/

// ğŸ”§ ä¿®æ­£å¾Œï¼šåŒæ–¹å‘æ¥ç¶šã‚’å¯èƒ½ã«ã™ã‚‹
async function initializeConnections() {
  const playersSnap = await get(ref(db, `rooms/${roomCode}/players`));
  const players = playersSnap.val() || {};
  const myUID = auth.currentUser.uid;

  console.log(`ğŸ” æ¥ç¶šå¯èƒ½ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç¢ºèªä¸­...`);
  
  for (const [uid, info] of Object.entries(players)) {
    if (uid === myUID) continue;
    
    if (info.cameraReady && !peerConnections[uid]) {
      console.log(`ğŸ›°ï¸ ${uid}ã®ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†ã‚’ç¢ºèªã€æ¥ç¶šé–‹å§‹`);
      // â­ é‡è¦ï¼šUIDã®å¤§å°æ¯”è¼ƒã‚’å‰Šé™¤ã—ã€ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ¥ç¶šã‚’è©¦è¡Œ
      await createConnectionWith(uid);
      // æ¥ç¶šé–“éš”ã‚’ç©ºã‘ã¦å®‰å®šæ€§ã‚’å‘ä¸Š
      await new Promise(resolve => setTimeout(resolve, 300));
    }
  }
}

// ğŸ”§ ä¿®æ­£å¾Œï¼šlistenForCameraReadyPlayersé–¢æ•°ã‚‚æ›´æ–°
function listenForCameraReadyPlayers() {
  const myUID = auth.currentUser.uid;
  const playersRef = ref(db, `rooms/${roomCode}/players`);

  onValue(playersRef, async (snapshot) => {
    const players = snapshot.val() || {};
    for (const [uid, info] of Object.entries(players)) {
      if (uid === myUID) continue;

      // â­ é‡è¦ï¼šUIDã®å¤§å°æ¯”è¼ƒã‚’å‰Šé™¤
      if (info.cameraReady && !peerConnections[uid]) {
        console.log("ğŸ›°ï¸ ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†ã‚’æ¤œçŸ¥ã€æ¥ç¶šé–‹å§‹ to:", uid);
        await createConnectionWith(uid);
        // åŒæ™‚æ¥ç¶šã‚’é¿ã‘ã‚‹ãŸã‚ã®é–“éš”
        await new Promise(resolve => setTimeout(resolve, 300));
      }
    }
  });
}

// ğŸ”§ startCameraAndConnecté–¢æ•°å†…ã®è©²å½“éƒ¨åˆ†ã‚‚ä¿®æ­£
async function startCameraAndConnect() {
  if (cameraStarted) {
    console.log("ğŸ“· ã‚«ãƒ¡ãƒ©ã¯æ—¢ã«èµ·å‹•ã—ã¦ã„ã¾ã™");
    return;
  }
  cameraStarted = true;
  
  try {
    await cleanupWebRTCConnections();
    
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

    const videoGrid = document.getElementById("videoGrid");
    videoGrid.style.display = "flex";

    const video = document.createElement("video");
    video.srcObject = localStream;
    video.autoplay = true;
    video.playsInline = true;
    video.muted = true;
    video.style.width = "200px";
    video.style.height = "150px";
    video.style.margin = "10px";
    videoGrid.appendChild(video);
    await video.play().catch(e => console.warn("ãƒ­ãƒ¼ã‚«ãƒ«å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));

    console.log("ğŸ“· ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ãƒ¡ãƒ©å–å¾—å®Œäº†");

    await set(ref(db, `rooms/${roomCode}/players/${auth.currentUser.uid}/cameraReady`), true);

    // â­ ä¿®æ­£ï¼šUIDã®å¤§å°æ¯”è¼ƒãªã—ã§å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ¥ç¶šã‚’è©¦è¡Œ
    await initializeConnections();

    listenForSignals();
    listenForCameraReadyPlayers();
    
  } catch (err) {
    console.error("ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    alert("ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚");
  }
}
