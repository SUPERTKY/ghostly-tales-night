// ä¿®æ­£ç‰ˆã®ã‚³ãƒ¼ãƒ‰ä¾‹

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentUserId = null;
let isCleaningUp = false;

// 1. èªè¨¼çŠ¶æ…‹å¤‰æ›´æ™‚ã®ä¿®æ­£ç‰ˆ
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    await signInAnonymously(auth);
    return;
  }

  if (sceneStarted) return;
  
  currentUserId = user.uid;
  
  // ğŸ”§ ä¿®æ­£ç‚¹1: æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¿…ãšã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  await cleanupExistingSession(user.uid);
  
  // ãã®å¾Œã§onDisconnectã‚’è¨­å®š
  const hostSnap = await get(ref(db, `rooms/${roomCode}/host`));
  const hostUID = hostSnap.exists() ? hostSnap.val() : null;

  if (user.uid === hostUID) {
    await onDisconnect(ref(db, `rooms/${roomCode}`)).remove();
  } else {
    await onDisconnect(ref(db, `rooms/${roomCode}/players/${user.uid}`)).remove();
  }

  sceneStarted = true;
  startSceneFlow();
});

// ğŸ”§ æ–°è¦è¿½åŠ : æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
async function cleanupExistingSession(uid) {
  try {
    console.log("ğŸ§¹ æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...");
    
    // 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã®å‰Šé™¤
    const playerRef = ref(db, `rooms/${roomCode}/players/${uid}`);
    const playerSnap = await get(playerRef);
    if (playerSnap.exists()) {
      await set(playerRef, null);
      console.log("ğŸ‘¤ æ—¢å­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    // 2. ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æƒ…å ±ã®å‰Šé™¤
    const signalRef = ref(db, `rooms/${roomCode}/signals/${uid}`);
    const signalSnap = await get(signalRef);
    if (signalSnap.exists()) {
      await set(signalRef, null);
      console.log("ğŸ“¡ æ—¢å­˜ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    // 3. ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã®ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æƒ…å ±ã‚‚å‰Šé™¤
    const allSignalsSnap = await get(ref(db, `rooms/${roomCode}/signals`));
    if (allSignalsSnap.exists()) {
      const allSignals = allSignalsSnap.val();
      for (const [fromUID, toMap] of Object.entries(allSignals)) {
        if (toMap && toMap[uid]) {
          await set(ref(db, `rooms/${roomCode}/signals/${fromUID}/${uid}`), null);
          console.log(`ğŸ“¡ ${fromUID}ã‹ã‚‰ã®ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
      }
    }

    // 4. å°‘ã—å¾…æ©Ÿï¼ˆFirebaseå´ã®åæ˜ å¾…ã¡ï¼‰
    await new Promise(resolve => setTimeout(resolve, 1000));
    
  } catch (error) {
    console.error("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:", error);
  }
}

// ğŸ”§ ä¿®æ­£ç‚¹2: WebRTCæ¥ç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
async function cleanupWebRTCConnections() {
  try {
    console.log("ğŸ”Œ WebRTCæ¥ç¶šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...");
    
    // æ—¢å­˜ã®PeerConnectionæ¥ç¶šã‚’ã™ã¹ã¦é–‰ã˜ã‚‹
    for (const [uid, pc] of Object.entries(peerConnections)) {
      if (pc) {
        pc.close();
        console.log(`ğŸ”Œ ${uid}ã¸ã®æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸ`);
      }
    }
    
    // PeerConnectionsã‚’ã‚¯ãƒªã‚¢
    Object.keys(peerConnections).forEach(key => {
      delete peerConnections[key];
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
    if (localStream) {
      localStream.getTracks().forEach(track => {
        track.stop();
        console.log("ğŸ“· ã‚«ãƒ¡ãƒ©ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ");
      });
      localStream = null;
    }

    // ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ã™ã¹ã¦å‰Šé™¤
    const videoGrid = document.getElementById("videoGrid");
    if (videoGrid) {
      videoGrid.innerHTML = "";
      console.log("ğŸ“º ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
    }
    
  } catch (error) {
    console.error("WebRTCã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:", error);
  }
}

// ğŸ”§ ä¿®æ­£ç‚¹3: ãƒšãƒ¼ã‚¸é›¢è„±å‡¦ç†ã®æ”¹å–„
let isPageUnloading = false;

// beforeunloadã‚¤ãƒ™ãƒ³ãƒˆ - ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ç›´å‰
window.addEventListener("beforeunload", async (event) => {
  isPageUnloading = true;
  await gracefulShutdown();
});

// visibilitychangeã¯è­¦å‘Šã®ã¿ã«å¤‰æ›´
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden" && !isPageUnloading) {
    console.warn("âš ï¸ ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãªã©ï¼‰");
    // å¼·åˆ¶çš„ã«ãƒšãƒ¼ã‚¸ç§»å‹•ã¯ã—ãªã„
    
    // å¿…è¦ã«å¿œã˜ã¦ä¸€æ™‚åœæ­¢å‡¦ç†
    if (timerInterval) {
      clearInterval(timerInterval);
      console.log("â¸ï¸ ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ");
    }
  } else if (document.visibilityState === "visible") {
    console.log("ğŸ‘ï¸ ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚Œã¾ã—ãŸ");
    
    // ã‚¿ã‚¤ãƒãƒ¼å†é–‹å‡¦ç†
    if (timerStarted && !timerInterval && remainingSeconds > 0) {
      startCountdown();
      console.log("â–¶ï¸ ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹ã—ã¾ã—ãŸ");
    }
  }
});

// ğŸ”§ æ–°è¦è¿½åŠ : é©åˆ‡ãªçµ‚äº†å‡¦ç†
async function gracefulShutdown() {
  if (isCleaningUp) return;
  isCleaningUp = true;
  
  try {
    console.log("ğŸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å‡¦ç†ã‚’é–‹å§‹...");
    
    // 1. WebRTCæ¥ç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    await cleanupWebRTCConnections();
    
    // 2. Firebaseæ¥ç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    if (currentUserId) {
      await cleanupExistingSession(currentUserId);
    }
    
    // 3. ã‚¿ã‚¤ãƒãƒ¼ã®åœæ­¢
    if (timerInterval) {
      clearInterval(timerInterval);
    }
    
    console.log("âœ… çµ‚äº†å‡¦ç†å®Œäº†");
    
  } catch (error) {
    console.error("çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
  }
}

// ğŸ”§ ä¿®æ­£ç‚¹4: WebRTCæ¥ç¶šé–‹å§‹å‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
async function startCameraAndConnect() {
  try {
    // é–‹å§‹å‰ã«æ—¢å­˜ã®æ¥ç¶šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    await cleanupWebRTCConnections();
    
    localStream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: false 
    });

    const video = document.createElement("video");
    video.srcObject = localStream;
    video.autoplay = true;
    video.playsInline = true;
    video.muted = true;
    video.style.width = "200px";
    video.style.height = "150px";
    video.style.margin = "10px";
    document.getElementById("videoGrid").appendChild(video);
    
    await video.play().catch(e => console.warn("ãƒ­ãƒ¼ã‚«ãƒ«å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
    console.log("ğŸ“· ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ãƒ¡ãƒ©å–å¾—å®Œäº†");

    // Firebaseå´ã®çŠ¶æ…‹æ›´æ–°
    await set(ref(db, `rooms/${roomCode}/players/${auth.currentUser.uid}/cameraReady`), true);

    // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®æ¥ç¶šé–‹å§‹
    const playersSnap = await get(ref(db, `rooms/${roomCode}/players`));
    const players = playersSnap.val();

    for (const uid in players) {
      if (uid !== auth.currentUser.uid) {
        console.log("ğŸ›°ï¸ æ¥ç¶šé–‹å§‹ to:", uid);
        await createConnectionWith(uid);
      }
    }

    listenForSignals();
    
  } catch (err) {
    console.error("ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    alert("ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
  }
}

// ğŸ”§ ä¿®æ­£ç‚¹5: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
async function createConnectionWith(remoteUID) {
  try {
    // æ—¢å­˜ã®æ¥ç¶šãŒã‚ã‚Œã°é–‰ã˜ã‚‹
    if (peerConnections[remoteUID]) {
      peerConnections[remoteUID].close();
      delete peerConnections[remoteUID];
    }

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    // æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
    pc.onconnectionstatechange = () => {
      console.log(`ğŸ”— ${remoteUID}ã¨ã®æ¥ç¶šçŠ¶æ…‹: ${pc.connectionState}`);
      
      if (pc.connectionState === 'failed') {
        console.warn(`âŒ ${remoteUID}ã¨ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ`);
        // å¿…è¦ã«å¿œã˜ã¦å†æ¥ç¶šå‡¦ç†
      }
    };

    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
    });

    pc.ontrack = (event) => {
      console.log("ğŸ¥ æ˜ åƒã‚’å—ä¿¡ from", remoteUID);
      
      // æ—¢å­˜ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒã‚ã‚Œã°å‰Šé™¤
      const existingVideo = document.querySelector(`[data-user-id="${remoteUID}"]`);
      if (existingVideo) {
        existingVideo.remove();
      }
      
      const remoteVideo = document.createElement("video");
      remoteVideo.setAttribute("data-user-id", remoteUID);
      remoteVideo.srcObject = event.streams[0];
      remoteVideo.autoplay = true;
      remoteVideo.playsInline = true;
      remoteVideo.style.width = "200px";
      remoteVideo.style.height = "150px";
      remoteVideo.style.margin = "10px";
      
      document.getElementById("videoGrid").appendChild(remoteVideo);
      remoteVideo.play().catch(e => console.warn("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log("â„ ICE candidate é€ä¿¡ to:", remoteUID);
        const signalRef = ref(db, `rooms/${roomCode}/signals/${auth.currentUser.uid}/${remoteUID}/candidates`);
        const newRef = push(signalRef);
        set(newRef, event.candidate);
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await set(ref(db, `rooms/${roomCode}/signals/${auth.currentUser.uid}/${remoteUID}/offer`), {
      type: offer.type,
      sdp: offer.sdp
    });

    peerConnections[remoteUID] = pc;
    console.log("ğŸ“¡ Offer é€ä¿¡å®Œäº† to:", remoteUID);
    
  } catch (error) {
    console.error(`${remoteUID}ã¨ã®æ¥ç¶šä½œæˆã‚¨ãƒ©ãƒ¼:`, error);
  }
}
